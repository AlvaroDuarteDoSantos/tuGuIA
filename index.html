<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Tours Interactivos</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .poi-card {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            width: 400px;
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-50%) translateY(100px);
            overflow: hidden;
        }

        .poi-card.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .poi-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            color: white;
        }

        .poi-content {
            padding: 20px;
        }

        .poi-card h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 22px;
            font-weight: 600;
        }

        .poi-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .distance-badge {
            display: inline-block;
            background: #f0f0f0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }

        .audio-button {
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 10px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .audio-button:hover {
            background: #0066CC;
            transform: translateY(-1px);
        }

        .audio-button:active {
            transform: translateY(0);
        }

        .audio-button.playing {
            background: #34C759;
        }

        .audio-button.playing .icon {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .audio-button.listened {
            background: #8E8E93;
            opacity: 0.8;
        }

        .extra-audios {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .extra-audios h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .extra-audio-button {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #F2F2F7;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .extra-audio-button:hover {
            background: #E5E5EA;
            transform: translateX(5px);
        }

        .extra-audio-button .icon {
            font-size: 16px;
        }

        .location-error {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FF3B30;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1001;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        /* Icono personalizado para POIs */
        .poi-marker {
            background: #007AFF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .poi-card {
                bottom: 10px;
                padding: 16px;
                width: calc(100% - 20px);
            }
            
            .poi-card h3 {
                font-size: 18px;
            }
            
            .audio-button {
                font-size: 15px;
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">Cargando mapa y ubicaci√≥n...</div>
    
    <!-- Template para las tarjetas de POI -->
    <div id="poi-card-template" class="poi-card" style="display: none;">
        <div class="poi-image" id="poi-image">üèõÔ∏è</div>
        <div class="poi-content">
            <h3 id="poi-name"></h3>
            <p class="poi-description" id="poi-description"></p>
            <span class="distance-badge" id="poi-distance"></span>
            <button class="audio-button" id="main-audio-btn">
                <span class="icon">üîä</span>
                <span>Escuchar introducci√≥n</span>
            </button>
            <div class="extra-audios" id="extra-audios-container" style="display: none;">
                <h4>üéß Descubre m√°s:</h4>
                <div id="extra-audios-list"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Estado global de la aplicaci√≥n
        const app = {
            map: null,
            userMarker: null,
            poiMarkers: [],
            pois: [],
            currentPOI: null,
            currentAudio: null,
            listenedAudios: new Set(),
            userLocation: null,
            watchId: null,
            activationRadius: 30 // metros
        };

        // Funci√≥n para calcular distancia entre dos puntos (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distancia en metros
        }

        // Cargar POIs desde el archivo JSON
        async function loadPOIs() {
            try {
                // Cargar desde el archivo JSON real
                const response = await fetch('pois.json');
                app.pois = await response.json();
                
                displayPOIs();
            } catch (error) {
                console.error('Error cargando POIs:', error);
                // Si hay error, mostrar mensaje
                const errorDiv = document.createElement('div');
                errorDiv.className = 'location-error';
                errorDiv.textContent = 'Error cargando puntos de inter√©s';
                document.body.appendChild(errorDiv);
            }
        }

        // Mostrar POIs en el mapa
        function displayPOIs() {
            app.pois.forEach(poi => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="poi-marker">üéß</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([poi.lat, poi.lng], { icon })
                    .addTo(app.map)
                    .bindPopup(`<b>${poi.nombre}</b>`);
                
                app.poiMarkers.push({ marker, poi });
            });
        }

        // Inicializar el mapa
        function initMap() {
            // Crear el mapa centrado en M√°laga (por defecto)
            app.map = L.map('map').setView([36.7213, -4.4214], 16);

            // A√±adir capa de tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(app.map);

            // Cargar POIs
            loadPOIs();
        }

        // Actualizar ubicaci√≥n del usuario
        function updateUserLocation(position) {
            const { latitude, longitude } = position.coords;
            app.userLocation = { lat: latitude, lng: longitude };

            // Crear o actualizar marcador del usuario
            if (!app.userMarker) {
                const userIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background: #007AFF; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                app.userMarker = L.marker([latitude, longitude], { icon: userIcon })
                    .addTo(app.map)
                    .bindPopup('Tu ubicaci√≥n');
                
                // Centrar el mapa en la ubicaci√≥n del usuario la primera vez
                app.map.setView([latitude, longitude], 17);
            } else {
                app.userMarker.setLatLng([latitude, longitude]);
            }

            // Verificar proximidad a POIs
            checkProximityToPOIs();
        }

        // Verificar proximidad a POIs
        function checkProximityToPOIs() {
            if (!app.userLocation) return;

            let closestPOI = null;
            let closestDistance = Infinity;

            app.pois.forEach(poi => {
                const distance = calculateDistance(
                    app.userLocation.lat,
                    app.userLocation.lng,
                    poi.lat,
                    poi.lng
                );

                if (distance < closestDistance && distance <= app.activationRadius) {
                    closestPOI = poi;
                    closestDistance = distance;
                }
            });

            if (closestPOI && closestPOI.id !== app.currentPOI?.id) {
                showPOICard(closestPOI, closestDistance);
            } else if (!closestPOI && app.currentPOI) {
                hidePOICard();
            } else if (closestPOI && app.currentPOI) {
                // Actualizar distancia
                updateDistance(closestDistance);
            }
        }

        // Mostrar tarjeta de POI
        function showPOICard(poi, distance) {
            app.currentPOI = poi;
            
            const card = document.getElementById('poi-card-template');
            document.getElementById('poi-name').textContent = poi.nombre;
            updateDistance(distance);
            
            // A√±adir imagen o emoji seg√∫n el POI
            const imageDiv = document.getElementById('poi-image');
            if (poi.imagen_url) {
                imageDiv.innerHTML = `<img src="${poi.imagen_url}" alt="${poi.nombre}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // Emojis por defecto seg√∫n el tipo de monumento
                const emojis = {
                    'catedral': '‚õ™',
                    'alcazaba': 'üè∞',
                    'teatro': 'üé≠',
                    'castillo': 'üèØ',
                    'plaza': 'üêÇ',
                    'mercado': 'üõí',
                    'museo': 'üñºÔ∏è',
                    'jardin': 'üå≥',
                    'puerto': '‚öì',
                    'calle': 'üö∂',
                    'iglesia': '‚õ™',
                    'parque': 'üå≤',
                    'palacio': 'üèõÔ∏è',
                    'banos': 'üèñÔ∏è',
                    'cementerio': 'üåπ',
                    'barrio': 'üé®'
                };
                
                let emoji = 'üèõÔ∏è'; // Por defecto
                for (let key in emojis) {
                    if (poi.id.toLowerCase().includes(key)) {
                        emoji = emojis[key];
                        break;
                    }
                }
                imageDiv.innerHTML = emoji;
                imageDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            // A√±adir descripci√≥n si existe
            const descDiv = document.getElementById('poi-description');
            if (poi.descripcion) {
                descDiv.textContent = poi.descripcion;
                descDiv.style.display = 'block';
            } else {
                // Descripciones por defecto
                const descripciones = {
                    'catedral_malaga': 'Impresionante catedral renacentista conocida como "La Manquita" por su torre inacabada.',
                    'alcazaba_malaga': 'Fortaleza palatina musulmana del siglo XI con impresionantes vistas de la ciudad.',
                    'teatro_romano': 'Teatro del siglo I a.C. descubierto en 1951, testigo de la M√°laga romana.',
                    'castillo_gibralfaro': 'Castillo del siglo XIV que corona la ciudad con las mejores vistas panor√°micas.',
                    'plaza_toros': 'Plaza de estilo neomud√©jar de 1876, conocida como La Malagueta.',
                    'mercado_central': 'Mercado hist√≥rico en un edificio del siglo XIV con puerta nazar√≠ original.',
                    'museo_picasso': 'Casa natal del genio malague√±o con m√°s de 200 obras del artista.',
                    'jardin_botanico': 'Jard√≠n hist√≥rico-art√≠stico con m√°s de 150 a√±os y especies de todo el mundo.',
                    'puerto_malaga': 'Puerto milenario renovado con el moderno Muelle Uno y el faro de La Farola.',
                    'centro_pompidou': 'Primera sede del Centre Pompidou fuera de Francia, en el colorido Cubo.',
                    'museo_carmen_thyssen': 'Palacio del siglo XVI con la mejor colecci√≥n de pintura andaluza del XIX.',
                    'calle_larios': 'La calle m√°s emblem√°tica de M√°laga, coraz√≥n comercial de la ciudad.',
                    'iglesia_santiago': 'Iglesia mud√©jar del siglo XV donde fue bautizado Pablo Picasso.',
                    'parque_malaga': 'Jard√≠n bot√°nico centenario con especies subtropicales √∫nicas en Europa.',
                    'palacio_aduana': 'Imponente palacio neocl√°sico que alberga el Museo de M√°laga.',
                    'banos_carmen': 'Hist√≥rico balneario del siglo XX, s√≠mbolo de la M√°laga marinera.',
                    'cementerio_ingles': 'Primer cementerio protestante de Espa√±a, jard√≠n rom√°ntico junto al mar.',
                    'museo_automovilistico': 'Antigua tabacalera con colecci√≥n √∫nica de coches cl√°sicos y moda.',
                    'soho_malaga': 'Barrio del arte urbano con murales de artistas internacionales.',
                    'casa_natal_picasso': 'Casa donde naci√≥ Picasso en 1881, en la hist√≥rica Plaza de la Merced.'
                };
                
                descDiv.textContent = descripciones[poi.id] || 'Descubre la historia de este emblem√°tico lugar de M√°laga.';
                descDiv.style.display = 'block';
            }
            
            // Configurar bot√≥n principal
            const mainBtn = document.getElementById('main-audio-btn');
            mainBtn.onclick = () => playAudio(poi.audio_intro_url, mainBtn);
            
            // Verificar si ya se escuch√≥
            if (app.listenedAudios.has(poi.audio_intro_url)) {
                mainBtn.classList.add('listened');
            }
            
            // Configurar audios extra
            if (poi.audios_extra && poi.audios_extra.length > 0) {
                const container = document.getElementById('extra-audios-container');
                const list = document.getElementById('extra-audios-list');
                
                list.innerHTML = '';
                poi.audios_extra.forEach(audio => {
                    const btn = document.createElement('button');
                    btn.className = 'extra-audio-button';
                    btn.innerHTML = `<span class="icon">‚ñ∂Ô∏è</span><span>${audio.titulo}</span>`;
                    btn.onclick = () => playAudio(audio.url, btn);
                    
                    if (app.listenedAudios.has(audio.url)) {
                        btn.classList.add('listened');
                    }
                    
                    list.appendChild(btn);
                });
                
                container.style.display = 'block';
            } else {
                document.getElementById('extra-audios-container').style.display = 'none';
            }
            
            card.style.display = 'block';
            setTimeout(() => card.classList.add('active'), 10);
        }

        // Actualizar distancia mostrada
        function updateDistance(distance) {
            const badge = document.getElementById('poi-distance');
            badge.textContent = `A ${Math.round(distance)} metros`;
        }

        // Ocultar tarjeta de POI
        function hidePOICard() {
            const card = document.getElementById('poi-card-template');
            card.classList.remove('active');
            setTimeout(() => {
                card.style.display = 'none';
                app.currentPOI = null;
            }, 300);
        }

        // Reproducir audio
        function playAudio(url, button) {
            // Si hay un audio reproduci√©ndose, detenerlo
            if (app.currentAudio) {
                app.currentAudio.pause();
                app.currentAudio = null;
                document.querySelectorAll('.audio-button, .extra-audio-button').forEach(btn => {
                    btn.classList.remove('playing');
                });
            }
            
            // Crear nuevo audio
            app.currentAudio = new Audio(url);
            button.classList.add('playing');
            
            // Marcar como escuchado
            app.listenedAudios.add(url);
            
            app.currentAudio.play().catch(error => {
                console.error('Error reproduciendo audio:', error);
                alert('No se pudo reproducir el audio. Aseg√∫rate de que el archivo existe.');
                button.classList.remove('playing');
            });
            
            app.currentAudio.onended = () => {
                button.classList.remove('playing');
                button.classList.add('listened');
                app.currentAudio = null;
            };
        }

        // Manejar errores de geolocalizaci√≥n
        function handleLocationError(error) {
            document.getElementById('loading').style.display = 'none';
            
            let message = 'Error obteniendo ubicaci√≥n';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Permisos de ubicaci√≥n denegados. Por favor, act√≠valos en tu navegador.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Ubicaci√≥n no disponible';
                    break;
                case error.TIMEOUT:
                    message = 'Tiempo de espera agotado';
                    break;
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'location-error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Inicializar aplicaci√≥n
        function init() {
            initMap();
            
            // Solicitar ubicaci√≥n del usuario
            if ('geolocation' in navigator) {
                app.watchId = navigator.geolocation.watchPosition(
                    position => {
                        document.getElementById('loading').style.display = 'none';
                        updateUserLocation(position);
                    },
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                document.getElementById('loading').textContent = 'Geolocalizaci√≥n no soportada';
            }
        }

        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            if (app.watchId) {
                navigator.geolocation.clearWatch(app.watchId);
            }
            if (app.currentAudio) {
                app.currentAudio.pause();
            }
        });

        // Iniciar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>